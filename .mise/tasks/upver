#!/usr/bin/env bash
#MISE description="Bump the project version (major|minor|patch)"
set -euo pipefail

USAGE="Usage: mise upver <major|minor|patch>"
VERSION_FILE="VERSION"

if [[ $# -ne 1 ]]; then
  echo "$USAGE"
  exit 1
fi

BUMP="$1"
CURRENT=$(cat "$VERSION_FILE" | tr -d '[:space:]')

IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

case "$BUMP" in
  major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
  minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
  patch) PATCH=$((PATCH + 1)) ;;
  *)
    echo "Error: argument must be major, minor, or patch"
    echo "$USAGE"
    exit 1
    ;;
esac

NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"

echo "$NEW_VERSION" > "$VERSION_FILE"

# Update Helm chart versions
CHART_FILE="helm/liteskill/Chart.yaml"
if [[ -f "$CHART_FILE" ]]; then
  sed -i "s/^version: .*/version: ${NEW_VERSION}/" "$CHART_FILE"
  sed -i "s/^appVersion: .*/appVersion: \"${NEW_VERSION}\"/" "$CHART_FILE"
  echo "Helm Chart.yaml updated"
fi

echo "${CURRENT} -> ${NEW_VERSION}"

git add "$VERSION_FILE" "$CHART_FILE"
git commit -m "bump version to ${NEW_VERSION}"
git tag "v${NEW_VERSION}"

echo "Tagged v${NEW_VERSION} â€” push with: git push origin main v${NEW_VERSION}"
